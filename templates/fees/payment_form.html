{% extends "base.html" %}

{% block title %}{{ title }} - SRBMC ERP{% endblock %}

{% block styles %}
<style>
#searchResults {
    position: absolute;
    z-index: 1000;
    background: white;
    border: 1px solid #ddd;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

#searchResults .dropdown-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}

#searchResults .dropdown-item:hover {
    background-color: #f8f9fa;
}

#searchResults .dropdown-item:last-child {
    border-bottom: none;
}

.position-relative {
    position: relative;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('fees') }}">Fee Management</a></li>
                <li class="breadcrumb-item active">{{ title }}</li>
            </ol>
        </nav>

        <h1 class="h3 mb-4">
            <i class="fas fa-credit-card"></i> {{ title }}
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Payment Information</h6>
            </div>
            <div class="card-body">
                <form method="POST" id="paymentForm">
                    {{ form.hidden_tag() }}

                    <!-- Student Selection -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">Student Details</h6>
                        {% if selected_student %}
                            {{ form.student_id(style="display: none;") }}
                            <!-- Student Details Display -->
                            <div id="studentDetails" class="card bg-light">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Student ID:</strong> <span id="studentId">{{ selected_student.student_unique_id }}</span></p>
                                            <p><strong>Name:</strong> <span id="studentName">{{ selected_student.first_name }} {{ selected_student.last_name }}</span></p>
                                            <p><strong>Course:</strong> <span id="studentCourse">{{ selected_student.current_course or 'N/A' }}</span></p>
                                        </div>
                                        <div class="col-md-6">
                                            {% if selected_fee_record %}
                                                {% set total_paid = selected_fee_record.calculated_total_fees_paid %}
                                                {% set total_fee_amount = selected_fee_record.total_fee|float or 0 %}
                                                {% set due_amount = total_fee_amount - total_paid %}
                                                <p><strong>Total Fees:</strong> ₹<span id="totalFees">{{ "%.2f"|format(total_fee_amount) }}</span></p>
                                                <p><strong>Paid Amount:</strong> ₹<span id="paidAmount">{{ "%.2f"|format(total_paid) }}</span></p>
                                                <p><strong>Due Amount:</strong> ₹<span id="dueAmount">{{ "%.2f"|format(due_amount) }}</span></p>
                                            {% else %}
                                                <p><strong>Total Fees:</strong> ₹<span id="totalFees">0.00</span></p>
                                                <p><strong>Paid Amount:</strong> ₹<span id="paidAmount">0.00</span></p>
                                                <p><strong>Due Amount:</strong> ₹<span id="dueAmount">0.00</span></p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="studentSearch" class="form-label">Search Student</label>
                                    <div class="position-relative">
                                        <input type="text" id="studentSearch" class="form-control" placeholder="Type student name or ID to search..." autocomplete="off">
                                        <div id="searchResults" class="dropdown-menu" style="display: none;"></div>
                                    </div>
                                    {{ form.student_id(style="display: none;") }}
                                    {% if form.student_id.errors %}
                                        <div class="text-danger">
                                            {% for error in form.student_id.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="text-muted">Start typing to search for students by name or ID</small>
                                </div>
                            </div>

                            <!-- Student Details Display (initially hidden) -->
                            <div id="studentDetails" class="card bg-light" style="display: none;">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Student ID:</strong> <span id="studentId">-</span></p>
                                            <p><strong>Name:</strong> <span id="studentName">-</span></p>
                                            <p><strong>Course:</strong> <span id="studentCourse">-</span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Total Fees:</strong> ₹<span id="totalFees">0.00</span></p>
                                            <p><strong>Paid Amount:</strong> ₹<span id="paidAmount">0.00</span></p>
                                            <p><strong>Due Amount:</strong> ₹<span id="dueAmount">0.00</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Payment Details -->
                    <h6 class="text-primary mb-3">Payment Details</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.amount.label(class="form-label") }}
                            {{ form.amount(class="form-control", placeholder="0.00", oninput="validateAmount()") }}
                            {% if form.amount.errors %}
                                <div class="text-danger">
                                    {% for error in form.amount.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="text-muted">Enter the amount to be paid</small>
                        </div>

                        <div class="col-md-6 mb-3">
                            {{ form.payment_mode.label(class="form-label") }}
                            {{ form.payment_mode(class="form-select") }}
                            {% if form.payment_mode.errors %}
                                <div class="text-danger">
                                    {% for error in form.payment_mode.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Additional Payment Details -->
                    <div id="additionalDetails" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="transactionRef" class="form-label">Transaction Reference</label>
                                <input type="text" class="form-control" id="transactionRef" placeholder="Transaction ID / Cheque Number">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="paymentDate" class="form-label">Payment Date</label>
                                <input type="date" class="form-control" id="paymentDate">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="paymentRemarks" class="form-label">Remarks</label>
                            <textarea class="form-control" id="paymentRemarks" rows="2" placeholder="Additional remarks (optional)"></textarea>
                        </div>
                    </div>

                    <!-- Payment Summary -->
                    <div id="paymentSummary" class="card bg-light" style="display: none;">
                        <div class="card-body">
                            <h6 class="card-title">Payment Summary</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Payment Amount:</strong> ₹<span id="summaryAmount">0.00</span></p>
                                    <p><strong>Payment Mode:</strong> <span id="summaryMode">-</span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Remaining Due:</strong> ₹<span id="remainingDue">0.00</span></p>
                                    <p><strong>Installment Number:</strong> <span id="installmentNumber">-</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('fees') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Fee Management
                        </a>
                        <div>
                            {{ form.submit(class="btn btn-primary", onclick="return handlePaymentSubmission()") }}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Payment Guidelines</h6>
            </div>
            <div class="card-body">
                <h6>Payment Modes:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-money-bill-wave text-success"></i> <strong>Cash:</strong> Immediate payment</li>
                    <li><i class="fas fa-credit-card text-primary"></i> <strong>Online:</strong> UPI/Net Banking</li>
                    <li><i class="fas fa-check text-info"></i> <strong>Cheque:</strong> Bank cheque</li>
                    <li><i class="fas fa-file-invoice text-warning"></i> <strong>DD:</strong> Demand Draft</li>
                </ul>

                <hr>

                <h6>Important Notes:</h6>
                <div class="alert alert-info">
                    <small>
                        <ul class="mb-0">
                            <li>Payment receipt will be generated automatically</li>
                            <li>Student can pay in multiple installments</li>
                            <li>Maximum 6 installments allowed per student</li>
                            <li>Payment amount cannot exceed due amount</li>
                        </ul>
                    </small>
                </div>

                <div class="alert alert-warning">
                    <small>
                        <strong>Scholarship Note:</strong> Government scholarship amounts do not reduce the total payment but are tracked separately.
                    </small>
                </div>
            </div>
        </div>

        <!-- Student's Payment History -->
        <div class="card shadow mt-4">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Student's Payment History</h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% if selected_student %}
                        {% set recent_invoices = selected_student.invoices[:5] %}
                        {% if recent_invoices %}
                            {% for invoice in recent_invoices %}
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">Installment {{ invoice.installment_number or 'N/A' }}</h6>
                                        <small>{{ invoice.date_time.strftime('%Y-%m-%d') if invoice.date_time else 'N/A' }}</small>
                                    </div>
                                    <p class="mb-1">₹{{ "%.2f"|format(invoice.invoice_amount) }} - Invoice #{{ invoice.invoice_number }}</p>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="list-group-item text-muted">No payment history found</div>
                        {% endif %}
                    {% else %}
                        <div class="list-group-item text-muted">Select a student to view payment history</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let studentsData = [];

{% if not selected_student %}
// Enable search functionality when no student is pre-selected
let searchTimeout;

function searchStudents(query) {
    if (query.length < 2) {
        hideSearchResults();
        return;
    }
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        fetch(`/api/search-students?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displaySearchResults(data.students);
                } else {
                    hideSearchResults();
                }
            })
            .catch(error => {
                console.error('Error searching students:', error);
                hideSearchResults();
            });
    }, 300);
}

function displaySearchResults(students) {
    const resultsContainer = document.getElementById('searchResults');
    resultsContainer.innerHTML = '';
    
    if (students.length === 0) {
        resultsContainer.innerHTML = '<div class="dropdown-item text-muted">No students found</div>';
    } else {
        students.forEach(student => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.style.cursor = 'pointer';
            item.innerHTML = `
                <div>
                    <strong>${student.student_unique_id}</strong> - ${student.first_name} ${student.last_name}
                    <br>
                    <small class="text-muted">${student.current_course}</small>
                </div>
            `;
            
            // Use mousedown instead of click to prevent blur event from hiding results first
            item.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Prevent blur event
                selectStudent(student);
            });
            
            // Also add click as fallback
            item.addEventListener('click', (e) => {
                e.preventDefault();
                selectStudent(student);
            });
            
            resultsContainer.appendChild(item);
        });
    }
    
    resultsContainer.style.display = 'block';
}

function hideSearchResults() {
    const resultsContainer = document.getElementById('searchResults');
    resultsContainer.style.display = 'none';
}

function selectStudent(student) {
    console.log('Selected student:', student);
    
    // Set the student data
    document.getElementById('studentSearch').value = `${student.student_unique_id} - ${student.first_name} ${student.last_name}`;
    document.getElementById('{{ form.student_id.id }}').value = student.id;
    
    // Hide search results immediately
    hideSearchResults();
    
    // Show student details section immediately
    const detailsDiv = document.getElementById('studentDetails');
    detailsDiv.style.display = 'block';
    
    // Load student fee details
    loadStudentDetails();
    
    // Remove focus from search input to prevent further searching
    document.getElementById('studentSearch').blur();
}

// Add event listeners for search functionality
document.getElementById('studentSearch').addEventListener('input', function(e) {
    searchStudents(e.target.value);
});

document.getElementById('studentSearch').addEventListener('blur', function() {
    // Delay hiding to allow for click events on results
    setTimeout(() => {
        // Only hide if no student was selected
        const resultsContainer = document.getElementById('searchResults');
        if (resultsContainer.style.display !== 'none') {
            hideSearchResults();
        }
    }, 300);
});

document.getElementById('studentSearch').addEventListener('focus', function() {
    const query = this.value;
    if (query.length >= 2) {
        searchStudents(query);
    }
});
{% endif %}

function loadStudentDetails(student = null) {
    {% if selected_student %}
        // Student is pre-selected, load their fee data
        const studentId = {{ selected_student.id }};
        window.studentFeeData = {
            {% if selected_fee_record %}
                total_fee: {{ selected_fee_record.total_fee or 0 }},
                paid_amount: {{ selected_fee_record.calculated_total_fees_paid }},
                due_amount: {{ (selected_fee_record.total_fee|float or 0) - selected_fee_record.calculated_total_fees_paid }},
                next_installment: getNextInstallmentForStudent()
            {% else %}
                total_fee: 0,
                paid_amount: 0,
                due_amount: 0,
                next_installment: 1
            {% endif %}
        };

        // Show additional details and payment summary
        document.getElementById('additionalDetails').style.display = 'block';
        updatePaymentSummary();
    {% else %}
        // Functionality for manual student selection
        const studentId = document.getElementById('{{ form.student_id.id }}').value;

        if (studentId && studentId !== '' && studentId !== '0') {
            console.log('Loading fee details for student ID:', studentId);
            
            // Show loading state and ensure details are visible
            const detailsDiv = document.getElementById('studentDetails');
            detailsDiv.style.display = 'block';
            
            document.getElementById('studentId').textContent = 'Loading...';
            document.getElementById('studentName').textContent = 'Loading...';
            document.getElementById('studentCourse').textContent = 'Loading...';
            document.getElementById('totalFees').textContent = 'Loading...';
            document.getElementById('paidAmount').textContent = 'Loading...';
            document.getElementById('dueAmount').textContent = 'Loading...';

            // Fetch fee details for the student
            fetch(`/api/student-fee-details/${studentId}`)
                .then(response => {
                    console.log('API Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API Response data:', data);
                    if (data.success) {
                        const feeData = data.fee_data;
                        window.studentFeeData = feeData; // Store for later use

                        // Update student details display
                        document.getElementById('studentId').textContent = data.student_unique_id || '-';
                        document.getElementById('studentName').textContent = data.student_name || '-';
                        document.getElementById('studentCourse').textContent = data.student_course || '-';
                        document.getElementById('totalFees').textContent = parseFloat(feeData.total_fee || 0).toLocaleString('en-IN', {minimumFractionDigits: 2});
                        document.getElementById('paidAmount').textContent = parseFloat(feeData.paid_amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2});
                        document.getElementById('dueAmount').textContent = parseFloat(feeData.due_amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2});

                        // Update payment history if available
                        if (data.payment_history) {
                            updatePaymentHistory(data.payment_history);
                        }

                        // Show additional details and payment summary
                        document.getElementById('additionalDetails').style.display = 'block';
                        updatePaymentSummary();
                    } else {
                        console.error('API returned error:', data.error || 'Unknown error');
                        document.getElementById('studentId').textContent = 'Error';
                        document.getElementById('studentName').textContent = 'Error loading details';
                        document.getElementById('studentCourse').textContent = '-';
                        document.getElementById('totalFees').textContent = '0.00';
                        document.getElementById('paidAmount').textContent = '0.00';
                        document.getElementById('dueAmount').textContent = '0.00';
                        if (window.SRBMCApp && window.SRBMCApp.showNotification) {
                            window.SRBMCApp.showNotification('Error loading student fee details: ' + (data.error || 'Unknown error'), 'error');
                        } else {
                            alert('Error loading student fee details: ' + (data.error || 'Unknown error'));
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading student details:', error);
                    document.getElementById('studentId').textContent = 'Error';
                    document.getElementById('studentName').textContent = 'Error loading details';
                    document.getElementById('studentCourse').textContent = '-';
                    document.getElementById('totalFees').textContent = '0.00';
                    document.getElementById('paidAmount').textContent = '0.00';
                    document.getElementById('dueAmount').textContent = '0.00';
                    if (window.SRBMCApp && window.SRBMCApp.showNotification) {
                        window.SRBMCApp.showNotification('Error loading student details: ' + error.message, 'error');
                    } else {
                        alert('Error loading student details: ' + error.message);
                    }
                });
        } else {
            console.log('No student ID provided, hiding details');
            document.getElementById('studentDetails').style.display = 'none';
            document.getElementById('additionalDetails').style.display = 'none';
            document.getElementById('paymentSummary').style.display = 'none';
        }
    {% endif %}
}

{% if selected_student and selected_fee_record %}
function getNextInstallmentForStudent() {
    const installments = [
        {{ selected_fee_record.installment_1 or 0 }},
        {{ selected_fee_record.installment_2 or 0 }},
        {{ selected_fee_record.installment_3 or 0 }},
        {{ selected_fee_record.installment_4 or 0 }},
        {{ selected_fee_record.installment_5 or 0 }},
        {{ selected_fee_record.installment_6 or 0 }}
    ];

    for (let i = 0; i < installments.length; i++) {
        if (installments[i] === 0) {
            return i + 1;
        }
    }
    return 7; // All installments paid
}
{% endif %}

function updatePaymentHistory(paymentHistory) {
    const paymentHistoryContainer = document.querySelector('.card:nth-last-child(1) .list-group');
    if (!paymentHistoryContainer) return;

    paymentHistoryContainer.innerHTML = '';

    if (paymentHistory.length === 0) {
        paymentHistoryContainer.innerHTML = '<div class="list-group-item text-muted">No payment history found</div>';
        return;
    }

    paymentHistory.forEach(payment => {
        const paymentItem = document.createElement('div');
        paymentItem.className = 'list-group-item';
        paymentItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">Installment ${payment.installment_number}</h6>
                <small>${payment.date}</small>
            </div>
            <p class="mb-1">₹${parseFloat(payment.amount).toLocaleString()} - Invoice #${payment.invoice_number}</p>
        `;
        paymentHistoryContainer.appendChild(paymentItem);
    });
}

function validateAmount() {
    const amountInput = document.getElementById('{{ form.amount.id }}');
    const dueAmount = parseFloat(document.getElementById('dueAmount').textContent.replace(',', ''));
    const enteredAmount = parseFloat(amountInput.value);

    if (enteredAmount > dueAmount) {
        amountInput.setCustomValidity('Payment amount cannot exceed due amount');
    } else {
        amountInput.setCustomValidity('');
    }

    updatePaymentSummary();
}

function updatePaymentSummary() {
    const amount = document.getElementById('{{ form.amount.id }}').value;
    const mode = document.getElementById('{{ form.payment_mode.id }}').value;
    const dueAmount = parseFloat(document.getElementById('dueAmount').textContent.replace(',', ''));
    const paymentAmount = parseFloat(amount) || 0;

    if (amount && mode) {
        document.getElementById('paymentSummary').style.display = 'block';
        document.getElementById('summaryAmount').textContent = paymentAmount.toLocaleString();
        document.getElementById('summaryMode').textContent = mode;
        document.getElementById('remainingDue').textContent = (dueAmount - paymentAmount).toLocaleString();
        document.getElementById('installmentNumber').textContent = getNextInstallmentNumber();
    } else {
        document.getElementById('paymentSummary').style.display = 'none';
    }
}

function getNextInstallmentNumber() {
    // Get from the loaded student data
    return window.studentFeeData?.next_installment || 1;
}



// Event listeners
document.getElementById('{{ form.payment_mode.id }}').addEventListener('change', updatePaymentSummary);

{% if not selected_student %}
// Student selection event listener for manual selection
document.getElementById('{{ form.student_id.id }}').addEventListener('change', function(e) {
    if (e.target.value) {
        loadStudentDetails();
    } else {
        document.getElementById('studentDetails').style.display = 'none';
        document.getElementById('additionalDetails').style.display = 'none';
        document.getElementById('paymentSummary').style.display = 'none';
        
        // Clear search input if student is deselected
        document.getElementById('studentSearch').value = '';
    }
});
{% endif %}

// Initialize payment date and load student details if pre-selected
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];

    {% if selected_student %}
        // Load details for pre-selected student
        loadStudentDetails();
    {% endif %}
});

function handlePaymentSubmission() {
    const studentId = document.getElementById('{{ form.student_id.id }}').value;
    const amount = document.getElementById('{{ form.amount.id }}').value;

    if (!studentId || !amount) {
        alert('Please select a student and enter payment amount');
        return false;
    }

    // Set a flag to show receipt option after form submission
    sessionStorage.setItem('showReceiptOption', 'true');
    sessionStorage.setItem('paymentStudentId', studentId);

    return true;
}

// Check if we should show receipt option after page reload
document.addEventListener('DOMContentLoaded', function() {
    if (sessionStorage.getItem('showReceiptOption') === 'true') {
        const studentId = sessionStorage.getItem('paymentStudentId');
        if (studentId) {
            showReceiptModal(studentId);
        }
        sessionStorage.removeItem('showReceiptOption');
        sessionStorage.removeItem('paymentStudentId');
    }
});

function showReceiptModal(studentId) {
    if (confirm('Payment processed successfully! Would you like to print the receipt now?')) {
        // Get the latest invoice for this student
        fetch(`/api/student-latest-invoice/${studentId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.invoice_id) {
                    window.open(`/invoice/${data.invoice_id}/pdf`, '_blank');
                } else {
                    alert('Receipt not available at this time');
                }
            })
            .catch(error => {
                console.error('Error getting receipt:', error);
                alert('Error loading receipt');
            });
    }
}
</script>
{% endblock %}