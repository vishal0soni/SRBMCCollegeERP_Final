
{% extends "base.html" %}

{% block title %}Invoice Details - SRBMC ERP{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-file-invoice"></i> Invoice Details
            </h1>
            <div class="d-flex gap-2">
                <a href="{{ url_for('invoices') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Invoices
                </a>
                <a href="{{ url_for('invoice_pdf', invoice_id=invoice.id) }}" class="btn btn-primary" target="_blank">
                    <i class="fas fa-file-pdf"></i> Download PDF
                </a>
                {% if current_user.role.access_type == 'Edit' %}
                    {% if not invoice.original_invoice_printed %}
                    <button class="btn btn-success" onclick="printInvoice({{ invoice.id }})" id="print-btn-{{ invoice.id }}">
                        <i class="fas fa-print"></i> Print
                    </button>
                    {% else %}
                    <button class="btn btn-secondary" disabled>
                        <i class="fas fa-print"></i> Printed
                    </button>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Single Page Invoice Details -->
<div class="row">
    <div class="col-12">
        <div class="card shadow" id="invoice-content">
            <div class="card-header text-center bg-primary text-white">
                <h4 class="mb-0">SHRI RAGHUNATH BISHNOI MEMORIAL COLLEGE</h4>
                <p class="mb-0">Raniwara, Jalore, Rajasthan</p>
                <h5 class="mt-2 mb-0">FEE RECEIPT</h5>
            </div>
            <div class="card-body">
                <!-- Invoice & Student Details in Single Row -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Invoice Information</h6>
                        <table class="table table-borderless table-sm">
                            <tr>
                                <td width="40%"><strong>Invoice Number:</strong></td>
                                <td>{{ invoice.invoice_number }}</td>
                            </tr>
                            <tr>
                                <td><strong>Date & Time:</strong></td>
                                <td>{{ invoice.date_time.strftime('%d/%m/%Y %H:%M') }}</td>
                            </tr>
                            <tr>
                                <td><strong>Installment:</strong></td>
                                <td><span class="badge bg-info">Installment {{ invoice.installment_number }}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Amount Paid:</strong></td>
                                <td><strong class="text-success">₹{{ "%.2f"|format(invoice.invoice_amount) }}</strong></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Student Information</h6>
                        <table class="table table-borderless table-sm">
                            <tr>
                                <td width="40%"><strong>Student ID:</strong></td>
                                <td>{{ student.student_unique_id }}</td>
                            </tr>
                            <tr>
                                <td><strong>Student Name:</strong></td>
                                <td>{{ student.first_name }} {{ student.last_name }}</td>
                            </tr>
                            <tr>
                                <td><strong>Father Name:</strong></td>
                                <td>{{ student.father_name or 'N/A' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Course:</strong></td>
                                <td>{{ student.current_course or 'N/A' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Phone:</strong></td>
                                <td>{{ student.phone or 'N/A' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Email:</strong></td>
                                <td>{{ student.email or 'N/A' }}</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Payment Details -->
                <div class="row mb-4 payment-details-section">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">Payment Details</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Description</th>
                                        <th class="text-end">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Installment {{ invoice.installment_number }} Payment for {{ student.current_course or 'Course' }}</td>
                                        <td class="text-end">₹{{ "%.2f"|format(invoice.invoice_amount) }}</td>
                                    </tr>
                                    <tr class="table-success">
                                        <th>Total Amount Paid</th>
                                        <th class="text-end">₹{{ "%.2f"|format(invoice.invoice_amount) }}</th>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                {% if fee_record %}
                <!-- Fee Summary -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">Fee Summary</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card bg-light border-info">
                                    <div class="card-body text-center py-3">
                                        <h6 class="card-title mb-1">Total Fee</h6>
                                        <h4 class="text-info mb-0">₹{{ "%.2f"|format(fee_record.total_fee or 0) }}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light border-success">
                                    <div class="card-body text-center py-3">
                                        <h6 class="card-title mb-1">Total Paid</h6>
                                        <h4 class="text-success mb-0">₹{{ "%.2f"|format((fee_record.installment_1 or 0) + (fee_record.installment_2 or 0) + (fee_record.installment_3 or 0) + (fee_record.installment_4 or 0) + (fee_record.installment_5 or 0) + (fee_record.installment_6 or 0)) }}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light border-danger">
                                    <div class="card-body text-center py-3">
                                        <h6 class="card-title mb-1">Balance Due</h6>
                                        <h4 class="text-danger mb-0">₹{{ "%.2f"|format((fee_record.total_fee or 0) - ((fee_record.installment_1 or 0) + (fee_record.installment_2 or 0) + (fee_record.installment_3 or 0) + (fee_record.installment_4 or 0) + (fee_record.installment_5 or 0) + (fee_record.installment_6 or 0))) }}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light border-warning">
                                    <div class="card-body text-center py-3">
                                        <h6 class="card-title mb-1">Current Payment</h6>
                                        <h4 class="text-warning mb-0">₹{{ "%.2f"|format(invoice.invoice_amount) }}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fee Structure Details -->
                <div class="row mb-4 fee-structure-section">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">Fee Structure</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fee Type</th>
                                        <th class="text-end">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if fee_record.course_tuition_fee %}
                                    <tr>
                                        <td>Course Tuition Fee</td>
                                        <td class="text-end">₹{{ "%.2f"|format(fee_record.course_tuition_fee) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if fee_record.enrollment_fee %}
                                    <tr>
                                        <td>Enrollment Fee</td>
                                        <td class="text-end">₹{{ "%.2f"|format(fee_record.enrollment_fee) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if fee_record.eligibility_certificate_fee %}
                                    <tr>
                                        <td>Eligibility Certificate Fee</td>
                                        <td class="text-end">₹{{ "%.2f"|format(fee_record.eligibility_certificate_fee) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if fee_record.university_affiliation_fee %}
                                    <tr>
                                        <td>University Affiliation Fee</td>
                                        <td class="text-end">₹{{ "%.2f"|format(fee_record.university_affiliation_fee) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if fee_record.university_sports_fee %}
                                    <tr>
                                        <td>University Sports Fee</td>
                                        <td class="text-end">₹{{ "%.2f"|format(fee_record.university_sports_fee) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if fee_record.university_development_fee %}
                                    <tr>
                                        <td>University Development Fee</td>
                                        <td class="text-end">₹{{ "%.2f"|format(fee_record.university_development_fee) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if fee_record.tc_cc_fee %}
                                    <tr>
                                        <td>TC/CC Fee</td>
                                        <td class="text-end">₹{{ "%.2f"|format(fee_record.tc_cc_fee) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if fee_record.miscellaneous_fee_1 %}
                                    <tr>
                                        <td>Miscellaneous Fee 1</td>
                                        <td class="text-end">₹{{ "%.2f"|format(fee_record.miscellaneous_fee_1) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if fee_record.miscellaneous_fee_2 %}
                                    <tr>
                                        <td>Miscellaneous Fee 2</td>
                                        <td class="text-end">₹{{ "%.2f"|format(fee_record.miscellaneous_fee_2) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if fee_record.miscellaneous_fee_3 %}
                                    <tr>
                                        <td>Miscellaneous Fee 3</td>
                                        <td class="text-end">₹{{ "%.2f"|format(fee_record.miscellaneous_fee_3) }}</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Payment History -->
                <div class="row mb-4 payment-history-section">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">Installment Payment History</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Installment</th>
                                        <th>Invoice Number</th>
                                        <th class="text-end">Amount Paid</th>
                                        <th class="text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for i in range(1, 7) %}
                                    {% set installment_amount = fee_record['installment_' + i|string] or 0 %}
                                    {% set invoice_number = fee_record['invoice' + i|string + '_number'] or '' %}
                                    <tr>
                                        <td>Installment {{ i }}</td>
                                        <td>{{ invoice_number if invoice_number else '-' }}</td>
                                        <td class="text-end">
                                            {% if installment_amount > 0 %}
                                                ₹{{ "%.2f"|format(installment_amount) }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if installment_amount > 0 %}
                                                <span class="badge bg-success">Paid</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Pending</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Student Address -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">Student Address</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-borderless table-sm">
                                    <tr>
                                        <td width="30%"><strong>Street:</strong></td>
                                        <td>{{ student.street or 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Area/Village:</strong></td>
                                        <td>{{ student.area_village or 'N/A' }}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-borderless table-sm">
                                    <tr>
                                        <td width="30%"><strong>City/Tehsil:</strong></td>
                                        <td>{{ student.city_tehsil or 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>State:</strong></td>
                                        <td>{{ student.state or 'N/A' }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="row">
                    <div class="col-12 text-center border-top pt-3">
                        <p class="text-muted mb-1"><strong>Thank you for your payment!</strong></p>
                        <p class="text-muted small mb-0">This is a computer-generated receipt. For any questions, please contact the college office.</p>
                        <p class="text-muted small">Generated on: {{ invoice.date_time.strftime('%d/%m/%Y %H:%M') }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function printInvoice(invoiceId) {
    // Print the current page
    window.print();
    
    // Listen for after print event
    window.onafterprint = function() {
        // Mark invoice as printed
        markPrinted(invoiceId);
        window.onafterprint = null; // Remove the event listener
    };
}

function markPrinted(invoiceId) {
    fetch(`/invoice/${invoiceId}/mark-printed`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update button to disabled state
            const printBtn = document.getElementById(`print-btn-${invoiceId}`);
            if (printBtn) {
                printBtn.className = 'btn btn-secondary';
                printBtn.disabled = true;
                printBtn.innerHTML = '<i class="fas fa-print"></i> Printed';
                printBtn.onclick = null;
            }
            alert('Invoice marked as printed successfully!');
        } else {
            alert('Error updating invoice status: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating invoice status');
    });
}

// Print styles
const style = document.createElement('style');
style.textContent = `
    @media print {
        @page {
            size: A4;
            margin: 0.5in;
        }
        
        /* Hide non-essential elements */
        .btn, nav, .d-flex.justify-content-between, .d-flex.gap-2 {
            display: none !important;
        }
        
        /* Card styling */
        .card {
            border: 1px solid #000 !important;
            box-shadow: none !important;
            page-break-inside: avoid;
        }
        
        .card-header {
            background: #f8f9fa !important;
            color: #000 !important;
            border-bottom: 2px solid #000 !important;
            text-align: center !important;
            padding: 10px !important;
            -webkit-print-color-adjust: exact !important;
            color-adjust: exact !important;
        }
        
        /* Color preservation */
        .bg-primary {
            background-color: #007bff !important;
            color: white !important;
        }
        .text-primary { color: #007bff !important; }
        .text-success { color: #28a745 !important; }
        .text-danger { color: #dc3545 !important; }
        .text-warning { color: #856404 !important; }
        .text-info { color: #17a2b8 !important; }
        
        .badge {
            color: white !important;
            padding: 3px 8px !important;
            border-radius: 4px !important;
            font-weight: bold !important;
        }
        .bg-success { background-color: #28a745 !important; }
        .bg-info { background-color: #17a2b8 !important; }
        .bg-secondary { background-color: #6c757d !important; }
        
        /* Typography */
        body { 
            font-size: 10px !important; 
            line-height: 1.2 !important;
            font-family: Arial, sans-serif !important;
        }
        
        h1, h2, h3, h4 { 
            font-size: 14px !important; 
            margin-bottom: 6px !important;
            font-weight: bold !important;
        }
        h5 { 
            font-size: 12px !important;
            margin-bottom: 4px !important;
        }
        h6 { 
            font-size: 11px !important; 
            margin-bottom: 4px !important;
            font-weight: bold !important;
        }
        
        /* Table styling */
        .table {
            font-size: 9px !important;
            margin-bottom: 6px !important;
        }
        .table th, .table td {
            padding: 3px 5px !important;
            line-height: 1.1 !important;
            border: 1px solid #dee2e6 !important;
        }
        .table-borderless th, .table-borderless td {
            border: none !important;
        }
        .table-light {
            background-color: #f8f9fa !important;
        }
        
        /* Layout adjustments */
        .container-fluid { 
            padding: 0 !important; 
            margin: 0 !important;
        }
        .row { 
            margin: 0 !important; 
        }
        .col-12, .col-md-6, .col-md-3 { 
            padding: 0 3px !important; 
        }
        
        .card-body {
            padding: 8px !important;
        }
        
        /* Spacing adjustments */
        .mb-4 { margin-bottom: 8px !important; }
        .mb-3 { margin-bottom: 6px !important; }
        .mb-2 { margin-bottom: 4px !important; }
        .mb-1 { margin-bottom: 2px !important; }
        .py-3 { padding: 3px 0 !important; }
        .pt-3 { padding-top: 3px !important; }
        .mt-2 { margin-top: 3px !important; }
        .mt-4 { margin-top: 5px !important; }
        
        /* Hide Fee Summary cards, Fee Structure Details, Payment Details, and Payment History from print preview */
        .card.bg-light.border-info,
        .card.bg-light.border-success,
        .card.bg-light.border-danger,
        .card.bg-light.border-warning,
        .fee-structure-section,
        .payment-details-section,
        .payment-history-section {
            display: none !important;
        }
        
        /* Footer styling */
        .border-top {
            border-top: 2px solid #000 !important;
            margin-top: 8px !important;
            padding-top: 6px !important;
        }
        
        /* Ensure content fits on one page */
        .table-responsive {
            overflow: visible !important;
        }
        
        /* Text adjustments for better readability */
        strong { font-weight: bold !important; }
        .text-center { text-align: center !important; }
        .text-end { text-align: right !important; }
        
        /* Prevent page breaks */
        tr, td, th { page-break-inside: avoid !important; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
