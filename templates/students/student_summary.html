{% extends "base.html" %}

{% block title %}Student Summary - SRBMC ERP{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <i class="fas fa-chart-pie"></i> Student Summary Dashboard
        </h1>
    </div>
</div>

<!-- Global Year Filter Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calendar-alt"></i> Academic Year Filter
                </h6>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label for="yearFilter" class="form-label">Select Academic Year:</label>
                        <select id="yearFilter" class="form-select" onchange="applyYearFilter()">
                            <!-- Years will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-8">
                        <div class="text-muted">
                            <small>
                                <i class="fas fa-info-circle"></i>
                                All charts and statistics will update automatically when you change the year.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Admissions</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalAdmissions">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-plus fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Gov. Scholarship Applied</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="govScholarshipApplied">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-file-alt fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Meera Rebate Applied</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="meeraRebateApplied">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-graduation-cap fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Courses Available</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="coursesAvailable">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-book fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-xl-4 col-lg-4 col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-2">
                <h6 class="m-0 font-weight-bold text-primary">Student Distribution by Course</h6>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="studentDistributionByCourseChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-lg-4 col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-2">
                <h6 class="m-0 font-weight-bold text-primary">Government Scholarship Status</h6>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="govScholarshipChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-lg-4 col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-2">
                <h6 class="m-0 font-weight-bold text-primary">Meera Rebate Scholarship Status</h6>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="meeraScholarshipChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-2">
                <h6 class="m-0 font-weight-bold text-primary">Category Distribution</h6>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="categoryDistributionChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-2">
                <h6 class="m-0 font-weight-bold text-primary">Monthly Admissions</h6>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="monthlyAdmissionsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Tables -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Course-wise Breakdown</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm" id="courseBreakdownTable">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th class="text-end">Students</th>
                                <th class="text-end">Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" class="text-center text-muted">Data will update based on selected year</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Category-wise Breakdown</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm" id="categoryBreakdownTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th class="text-end">Students</th>
                                <th class="text-end">Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" class="text-center text-muted">Data will update based on selected year</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let studentDistributionChart;
let govScholarshipChart;
let meeraScholarshipChart;
let categoryChart;
let monthlyChart;
let currentYear = new Date().getFullYear();

document.addEventListener('DOMContentLoaded', function() {
    loadYearOptions();
    loadStudentSummaryData();
});

function loadYearOptions() {
    const yearFilter = document.getElementById("yearFilter");
    const startYear = 2020;
    const endYear = new Date().getFullYear() + 1;

    for (let year = endYear; year >= startYear; year--) {
        const option = document.createElement("option");
        option.value = year;
        option.textContent = `${year}-${(year + 1).toString().slice(-2)}`;
        
        if (year === currentYear) {
            option.selected = true;
        }
        
        yearFilter.appendChild(option);
    }
}

function applyYearFilter() {
    const selectedYear = parseInt(document.getElementById("yearFilter").value);
    currentYear = selectedYear;
    
    const yearFilter = document.getElementById("yearFilter");
    yearFilter.disabled = true;
    
    loadStudentSummaryData().finally(() => {
        yearFilter.disabled = false;
    });
}

function loadStudentSummaryData() {
    console.log('Loading student summary data for year:', currentYear);
    return Promise.all([
        loadStudentStats(),
        loadStudentDistributionChart(),
        loadScholarshipCharts(),
        loadCategoryChart(),
        loadMonthlyAdmissionsChart(),
        loadBreakdownTables()
    ]).then(() => {
        console.log('All student summary data loaded successfully');
    }).catch(error => {
        console.error('Error loading student summary data:', error);
    });
}

function loadBreakdownTables() {
    console.log('Loading breakdown tables for year:', currentYear);
    return fetch(`/api/student-breakdown-data?year=${currentYear}`)
        .then(response => response.json())
        .then(data => {
            console.log('Breakdown data loaded:', data);
            if (data.success) {
                updateCourseBreakdownTableFromAPI(data.course_breakdown);
                updateCategoryBreakdownTableFromAPI(data.category_breakdown);
            } else {
                // Show error state
                updateCourseBreakdownTableFromAPI([]);
                updateCategoryBreakdownTableFromAPI([]);
            }
        })
        .catch(error => {
            console.error('Error loading breakdown tables:', error);
            updateCourseBreakdownTableFromAPI([]);
            updateCategoryBreakdownTableFromAPI([]);
        });
}

function updateCourseBreakdownTableFromAPI(courseBreakdown) {
    const tbody = document.querySelector('#courseBreakdownTable tbody');
    
    if (!tbody) {
        console.error('Course breakdown table body not found');
        return;
    }
    
    tbody.innerHTML = '';

    if (!courseBreakdown || courseBreakdown.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No data available for selected year</td></tr>';
        return;
    }

    courseBreakdown.forEach(course => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td title="${course.name}">${course.name}</td>
            <td class="text-end">${course.count}</td>
            <td class="text-end">${course.percentage}%</td>
        `;
        tbody.appendChild(row);
    });
}

function updateCategoryBreakdownTableFromAPI(categoryBreakdown) {
    const tbody = document.querySelector('#categoryBreakdownTable tbody');
    
    if (!tbody) {
        console.error('Category breakdown table body not found');
        return;
    }
    
    tbody.innerHTML = '';

    if (!categoryBreakdown || categoryBreakdown.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No data available for selected year</td></tr>';
        return;
    }

    categoryBreakdown.forEach(category => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${category.name}</td>
            <td class="text-end">${category.count}</td>
            <td class="text-end">${category.percentage}%</td>
        `;
        tbody.appendChild(row);
    });
}

function loadStudentStats() {
    console.log('Loading student stats for year:', currentYear);
    return fetch(`/api/student-summary-stats?year=${currentYear}`)
        .then(response => response.json())
        .then(data => {
            console.log('Student stats received:', data);
            if (data.success) {
                document.getElementById('totalAdmissions').textContent = data.stats.total_admissions || 0;
                document.getElementById('govScholarshipApplied').textContent = data.stats.gov_scholarship_applied || 0;
                document.getElementById('meeraRebateApplied').textContent = data.stats.meera_rebate_applied || 0;
                document.getElementById('coursesAvailable').textContent = (data.stats.courses_available || 0) + ' courses';
            } else {
                // Show error state
                document.getElementById('totalAdmissions').textContent = '0';
                document.getElementById('govScholarshipApplied').textContent = '0';
                document.getElementById('meeraRebateApplied').textContent = '0';
                document.getElementById('coursesAvailable').textContent = '0 courses';
            }
        })
        .catch(error => {
            console.error('Error loading student stats:', error);
            document.getElementById('totalAdmissions').textContent = 'Error';
            document.getElementById('govScholarshipApplied').textContent = 'Error';
            document.getElementById('meeraRebateApplied').textContent = 'Error';
            document.getElementById('coursesAvailable').textContent = 'Error';
        });
}

function loadStudentDistributionChart() {
    console.log('Loading student distribution by course for year:', currentYear);
    return fetch(`/api/student-stats?year=${currentYear}`)
        .then(response => response.json())
        .then(data => {
            console.log('Student distribution by course data loaded:', data);
            const ctx = document.getElementById('studentDistributionByCourseChart').getContext('2d');
            
            if (studentDistributionChart) {
                studentDistributionChart.destroy();
            }

            const courses = data.courses || ['No Data'];
            const counts = data.counts || [0];

            studentDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: courses,
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796',
                            '#5a5c69', '#f8f9fc', '#5777ba', '#1f9e6b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10
                                },
                                padding: 10
                            }
                        }
                    }
                }
            });

            // Course breakdown table will be updated by loadBreakdownTables()
        })
        .catch(error => {
            console.error('Error loading student distribution by course:', error);
            // Error state handled by loadBreakdownTables()
        });
}

function loadScholarshipCharts() {
    console.log('Loading scholarship charts for year:', currentYear);
    
    // Get government scholarship counts directly by counting student records
    Promise.all([
        fetch(`/api/student-summary-stats?year=${currentYear}`),
        // Get detailed scholarship data from students
        fetch(`/api/scholarship-stats?year=${currentYear}`)
    ]).then(responses => {
        return Promise.all(responses.map(r => r.json()));
    }).then(([summaryData, scholarshipData]) => {
        console.log('Scholarship data loaded:', summaryData, scholarshipData);
        
        // Government Scholarship Chart
        const govCtx = document.getElementById('govScholarshipChart').getContext('2d');
        if (govScholarshipChart) {
            govScholarshipChart.destroy();
        }

        // Use data from scholarship API for government scholarships
        const govApplied = scholarshipData.scholarship_applied ? scholarshipData.scholarship_applied[0] : 0;
        const govApproved = scholarshipData.scholarship_approved ? scholarshipData.scholarship_approved[0] : 0;
        const govGranted = scholarshipData.scholarship_granted ? scholarshipData.scholarship_granted[0] : 0;
        const govTotal = govApplied + govApproved + govGranted;

        if (govTotal === 0) {
            govScholarshipChart = new Chart(govCtx, {
                type: 'doughnut',
                data: {
                    labels: ['No Data Available'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#e3e6f0']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 10 },
                                padding: 8
                            }
                        }
                    }
                }
            });
        } else {
            govScholarshipChart = new Chart(govCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Applied', 'Approved', 'Granted'],
                    datasets: [{
                        data: [govApplied, govApproved, govGranted],
                        backgroundColor: ['#f6c23e', '#1cc88a', '#4e73df']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 10 },
                                padding: 8
                            }
                        }
                    }
                }
            });
        }

        // Meera Rebate Chart
        const meeraCtx = document.getElementById('meeraScholarshipChart').getContext('2d');
        if (meeraScholarshipChart) {
            meeraScholarshipChart.destroy();
        }

        const meeraApplied = scholarshipData.scholarship_applied ? scholarshipData.scholarship_applied[1] : 0;
        const meeraApproved = scholarshipData.scholarship_approved ? scholarshipData.scholarship_approved[1] : 0;
        const meeraGranted = scholarshipData.scholarship_granted ? scholarshipData.scholarship_granted[1] : 0;
        const meeraTotal = meeraApplied + meeraApproved + meeraGranted;

        if (meeraTotal === 0) {
            meeraScholarshipChart = new Chart(meeraCtx, {
                type: 'doughnut',
                data: {
                    labels: ['No Data Available'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#e3e6f0']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 10 },
                                padding: 8
                            }
                        }
                    }
                }
            });
        } else {
            meeraScholarshipChart = new Chart(meeraCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Applied', 'Approved', 'Granted'],
                    datasets: [{
                        data: [meeraApplied, meeraApproved, meeraGranted],
                        backgroundColor: ['#f6c23e', '#1cc88a', '#4e73df']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 10 },
                                padding: 8
                            }
                        }
                    }
                }
            });
        }
    }).catch(error => {
        console.error('Error loading scholarship data:', error);
        // Show error states for both charts
        createErrorChart('govScholarshipChart', govScholarshipChart);
        createErrorChart('meeraScholarshipChart', meeraScholarshipChart);
    });
}

function createErrorChart(chartId, chartVariable) {
    const ctx = document.getElementById(chartId).getContext('2d');
    if (chartVariable) {
        chartVariable.destroy();
    }
    return new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Error Loading'],
            datasets: [{
                data: [1],
                backgroundColor: ['#e74a3b']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: { size: 10 },
                        padding: 8
                    }
                }
            }
        }
    });
}

function loadCategoryChart() {
    console.log('Loading category chart for year:', currentYear);
    return fetch(`/api/student-category-stats?year=${currentYear}`)
        .then(response => {
            console.log('Category API response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Category distribution data loaded:', data);
            const ctx = document.getElementById('categoryDistributionChart').getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
            }

            if (data.success && data.categories && data.categories.length > 0) {
                const categories = data.categories;
                const counts = data.counts;
                
                console.log('Categories:', categories);
                console.log('Counts:', counts);

                categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: categories,
                        datasets: [{
                            data: counts,
                            backgroundColor: [
                                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 10
                                    },
                                    padding: 10,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '50%'
                    }
                });
            } else {
                console.log('No category data available, showing placeholder');
                // Show no data state
                categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: [`No Students for ${currentYear}`],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#e3e6f0']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 10
                                    },
                                    padding: 10
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error loading category data:', error);
            // Show error state chart
            const ctx = document.getElementById('categoryDistributionChart').getContext('2d');
            if (categoryChart) {
                categoryChart.destroy();
            }
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Error Loading Data'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#e74a3b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10
                                },
                                padding: 10
                            }
                        }
                    }
                }
            });
        });
}

// Table update functions moved to loadBreakdownTables() section above

function loadMonthlyAdmissionsChart() {
    console.log('Loading monthly admissions chart for year:', currentYear);
    return fetch(`/api/monthly-admissions-stats?year=${currentYear}`)
        .then(response => {
            console.log('Monthly admissions API response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Monthly admissions data loaded:', data);
            const ctx = document.getElementById('monthlyAdmissionsChart').getContext('2d');
            
            if (monthlyChart) {
                monthlyChart.destroy();
            }

            if (data.success && data.labels && data.labels.length > 0) {
                const labels = data.labels;
                const counts = data.counts;
                
                console.log('Monthly labels:', labels);
                console.log('Monthly counts:', counts);

                monthlyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Monthly Admissions',
                            data: counts,
                            borderColor: '#1cc88a',
                            backgroundColor: 'rgba(28, 200, 138, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#1cc88a',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 10
                                    },
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        return `Admissions: ${context.parsed.y}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: {
                                        size: 10
                                    },
                                    stepSize: 1,
                                    precision: 0,
                                    callback: function(value) {
                                        if (value % 1 === 0) {
                                            return value;
                                        }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Number of Students',
                                    font: {
                                        size: 10,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 10
                                    },
                                    maxRotation: 45
                                },
                                title: {
                                    display: true,
                                    text: 'Month',
                                    font: {
                                        size: 10,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            } else {
                console.log('No monthly admissions data available, showing placeholder');
                // Show no data state
                monthlyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [`No Admissions in ${currentYear}`],
                        datasets: [{
                            label: 'No Data',
                            data: [0],
                            borderColor: '#e3e6f0',
                            backgroundColor: 'rgba(227, 230, 240, 0.1)',
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                display: false
                            },
                            x: {
                                display: true,
                                ticks: {
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error loading monthly admissions data:', error);
            // Show error state chart
            const ctx = document.getElementById('monthlyAdmissionsChart').getContext('2d');
            if (monthlyChart) {
                monthlyChart.destroy();
            }
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Error Loading Data'],
                    datasets: [{
                        label: 'Error',
                        data: [0],
                        borderColor: '#e74a3b',
                        backgroundColor: 'rgba(231, 74, 59, 0.1)',
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            display: false
                        },
                        x: {
                            display: true,
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        });
}
</script>
{% endblock %}