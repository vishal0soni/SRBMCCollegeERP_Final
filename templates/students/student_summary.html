{% extends "base.html" %}

{% block title %}Student Summary - SRBMC ERP{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <i class="fas fa-chart-pie"></i> Student Summary Dashboard
        </h1>
    </div>
</div>

<!-- Global Year Filter Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calendar-alt"></i> Academic Year Filter
                </h6>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label for="yearFilter" class="form-label">Select Academic Year:</label>
                        <select id="yearFilter" class="form-select" onchange="applyYearFilter()">
                            <!-- Years will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-8">
                        <div class="text-muted">
                            <small>
                                <i class="fas fa-info-circle"></i>
                                All charts and statistics will update automatically when you change the year.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Admissions</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalAdmissions">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-plus fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Gov. Scholarship Applied</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="govScholarshipApplied">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-file-alt fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Meera Rebate Applied</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="meeraRebateApplied">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-graduation-cap fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Courses Available</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="coursesAvailable">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-book fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-xl-4 col-lg-4 col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-2">
                <h6 class="m-0 font-weight-bold text-primary">Course-wise Distribution</h6>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="courseDistributionChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-lg-4 col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-2">
                <h6 class="m-0 font-weight-bold text-primary">Government Scholarship Status</h6>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="govScholarshipChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-lg-4 col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-2">
                <h6 class="m-0 font-weight-bold text-primary">Meera Rebate Scholarship Status</h6>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="meeraScholarshipChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-2">
                <h6 class="m-0 font-weight-bold text-primary">Category Distribution</h6>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="categoryDistributionChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-2">
                <h6 class="m-0 font-weight-bold text-primary">Monthly Admissions</h6>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="monthlyAdmissionsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Tables -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Course-wise Breakdown</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm" id="courseBreakdownTable">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th class="text-end">Students</th>
                                <th class="text-end">Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" class="text-center text-muted">Data will update based on selected year</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Category-wise Breakdown</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm" id="categoryBreakdownTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th class="text-end">Students</th>
                                <th class="text-end">Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" class="text-center text-muted">Data will update based on selected year</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let courseChart;
let govScholarshipChart;
let meeraScholarshipChart;
let categoryChart;
let monthlyChart;
let currentYear = new Date().getFullYear();

document.addEventListener('DOMContentLoaded', function() {
    loadYearOptions();
    loadStudentSummaryData();
});

function loadYearOptions() {
    const yearFilter = document.getElementById("yearFilter");
    const startYear = 2020;
    const endYear = new Date().getFullYear() + 1;

    for (let year = endYear; year >= startYear; year--) {
        const option = document.createElement("option");
        option.value = year;
        option.textContent = `${year}-${(year + 1).toString().slice(-2)}`;
        
        if (year === currentYear) {
            option.selected = true;
        }
        
        yearFilter.appendChild(option);
    }
}

function applyYearFilter() {
    const selectedYear = parseInt(document.getElementById("yearFilter").value);
    currentYear = selectedYear;
    
    const yearFilter = document.getElementById("yearFilter");
    yearFilter.disabled = true;
    
    loadStudentSummaryData().finally(() => {
        yearFilter.disabled = false;
    });
}

function loadStudentSummaryData() {
    console.log('Loading student summary data for year:', currentYear);
    return Promise.all([
        loadStudentStats(),
        loadCourseDistributionChart(),
        loadScholarshipCharts(),
        loadCategoryChart(),
        loadMonthlyAdmissionsChart()
    ]).then(() => {
        console.log('All student summary data loaded successfully');
    }).catch(error => {
        console.error('Error loading student summary data:', error);
    });
}

function loadStudentStats() {
    console.log('Loading student stats for year:', currentYear);
    return fetch(`/api/student-summary-stats?year=${currentYear}`)
        .then(response => response.json())
        .then(data => {
            console.log('Student stats received:', data);
            if (data.success) {
                document.getElementById('totalAdmissions').textContent = data.stats.total_admissions || 0;
                document.getElementById('govScholarshipApplied').textContent = data.stats.gov_scholarship_applied || 0;
                document.getElementById('meeraRebateApplied').textContent = data.stats.meera_rebate_applied || 0;
                document.getElementById('coursesAvailable').textContent = (data.stats.courses_available || 0) + ' courses';
            } else {
                // Show error state
                document.getElementById('totalAdmissions').textContent = '0';
                document.getElementById('govScholarshipApplied').textContent = '0';
                document.getElementById('meeraRebateApplied').textContent = '0';
                document.getElementById('coursesAvailable').textContent = '0 courses';
            }
        })
        .catch(error => {
            console.error('Error loading student stats:', error);
            document.getElementById('totalAdmissions').textContent = 'Error';
            document.getElementById('govScholarshipApplied').textContent = 'Error';
            document.getElementById('meeraRebateApplied').textContent = 'Error';
            document.getElementById('coursesAvailable').textContent = 'Error';
        });
}

function loadCourseDistributionChart() {
    return fetch(`/api/student-stats?year=${currentYear}`)
        .then(response => response.json())
        .then(data => {
            console.log('Course distribution data loaded:', data);
            const ctx = document.getElementById('courseDistributionChart').getContext('2d');
            
            if (courseChart) {
                courseChart.destroy();
            }

            const courses = data.courses || ['No Data'];
            const counts = data.counts || [0];

            courseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: courses,
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796',
                            '#5a5c69', '#f8f9fc', '#5777ba', '#1f9e6b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10
                                },
                                padding: 10
                            }
                        }
                    }
                }
            });

            // Update course breakdown table with proper data
            updateCourseBreakdownTable(courses, counts);
        })
        .catch(error => {
            console.error('Error loading course distribution:', error);
            // Show error state in table
            updateCourseBreakdownTable(['Error Loading'], [0]);
        });
}

function loadScholarshipCharts() {
    return fetch(`/api/scholarship-stats?year=${currentYear}`)
        .then(response => response.json())
        .then(data => {
            // Government Scholarship Chart
            const govCtx = document.getElementById('govScholarshipChart').getContext('2d');
            if (govScholarshipChart) {
                govScholarshipChart.destroy();
            }

            const govApplied = data.scholarship_applied ? data.scholarship_applied[0] : 0;
            const govApproved = data.scholarship_approved ? data.scholarship_approved[0] : 0;
            const govGranted = data.scholarship_granted ? data.scholarship_granted[0] : 0;
            const govTotal = govApplied + govApproved + govGranted;

            if (govTotal === 0) {
                govScholarshipChart = new Chart(govCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['No Data Available'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#e3e6f0']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: { size: 10 },
                                    padding: 8
                                }
                            }
                        }
                    }
                });
            } else {
                govScholarshipChart = new Chart(govCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Applied', 'Approved', 'Granted'],
                        datasets: [{
                            data: [govApplied, govApproved, govGranted],
                            backgroundColor: ['#f6c23e', '#1cc88a', '#4e73df']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: { size: 10 },
                                    padding: 8
                                }
                            }
                        }
                    }
                });
            }

            // Meera Rebate Chart
            const meeraCtx = document.getElementById('meeraScholarshipChart').getContext('2d');
            if (meeraScholarshipChart) {
                meeraScholarshipChart.destroy();
            }

            const meeraApplied = data.scholarship_applied ? data.scholarship_applied[1] : 0;
            const meeraApproved = data.scholarship_approved ? data.scholarship_approved[1] : 0;
            const meeraGranted = data.scholarship_granted ? data.scholarship_granted[1] : 0;
            const meeraTotal = meeraApplied + meeraApproved + meeraGranted;

            if (meeraTotal === 0) {
                meeraScholarshipChart = new Chart(meeraCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['No Data Available'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#e3e6f0']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: { size: 10 },
                                    padding: 8
                                }
                            }
                        }
                    }
                });
            } else {
                meeraScholarshipChart = new Chart(meeraCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Applied', 'Approved', 'Granted'],
                        datasets: [{
                            data: [meeraApplied, meeraApproved, meeraGranted],
                            backgroundColor: ['#f6c23e', '#1cc88a', '#4e73df']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: { size: 10 },
                                    padding: 8
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => console.error('Error loading scholarship data:', error));
}

function loadCategoryChart() {
    console.log('Loading category chart for year:', currentYear);
    return fetch(`/api/student-category-stats?year=${currentYear}`)
        .then(response => response.json())
        .then(data => {
            console.log('Category distribution data loaded:', data);
            const ctx = document.getElementById('categoryDistributionChart').getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
            }

            const categories = data.categories || ['No Data'];
            const counts = data.counts || [0];

            categoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Students',
                        data: counts,
                        backgroundColor: '#4e73df'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 10
                                },
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });

            // Update category breakdown table with proper data
            updateCategoryBreakdownTable(categories, counts);
        })
        .catch(error => {
            console.error('Error loading category data:', error);
            // Show error state chart
            const ctx = document.getElementById('categoryDistributionChart').getContext('2d');
            if (categoryChart) {
                categoryChart.destroy();
            }
            categoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Error Loading Data'],
                    datasets: [{
                        label: 'Error',
                        data: [0],
                        backgroundColor: '#e74a3b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            // Show error state in table
            updateCategoryBreakdownTable(['Error Loading'], [0]);
        });
}

function updateCourseBreakdownTable(courses, counts) {
    console.log('Updating course table with:', courses, counts);
    const tbody = document.querySelector('#courseBreakdownTable tbody');
    
    if (!tbody) {
        console.error('Course breakdown table body not found');
        return;
    }
    
    tbody.innerHTML = '';

    if (!courses || courses.length === 0 || (courses.length === 1 && (courses[0] === 'No Data' || courses[0] === 'Error Loading'))) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No data available for selected year</td></tr>';
        return;
    }

    const total = counts.reduce((sum, count) => sum + count, 0);
    
    for (let i = 0; i < courses.length; i++) {
        const course = courses[i] || 'Unknown Course';
        const count = counts[i] || 0;
        const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td title="${course}">${course}</td>
            <td class="text-end">${count}</td>
            <td class="text-end">${percentage}%</td>
        `;
        tbody.appendChild(row);
    }
}

function updateCategoryBreakdownTable(categories, counts) {
    console.log('Updating category table with:', categories, counts);
    const tbody = document.querySelector('#categoryBreakdownTable tbody');
    
    if (!tbody) {
        console.error('Category breakdown table body not found');
        return;
    }
    
    tbody.innerHTML = '';

    if (!categories || categories.length === 0 || (categories.length === 1 && (categories[0] === 'No Data' || categories[0] === 'Error Loading'))) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No data available for selected year</td></tr>';
        return;
    }

    const total = counts.reduce((sum, count) => sum + count, 0);
    
    for (let i = 0; i < categories.length; i++) {
        const category = categories[i] || 'Not Specified';
        const count = counts[i] || 0;
        const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${category}</td>
            <td class="text-end">${count}</td>
            <td class="text-end">${percentage}%</td>
        `;
        tbody.appendChild(row);
    }
}

function loadMonthlyAdmissionsChart() {
    console.log('Loading monthly admissions chart for year:', currentYear);
    return fetch(`/api/monthly-admissions-stats?year=${currentYear}`)
        .then(response => response.json())
        .then(data => {
            console.log('Monthly admissions data loaded:', data);
            const ctx = document.getElementById('monthlyAdmissionsChart').getContext('2d');
            
            if (monthlyChart) {
                monthlyChart.destroy();
            }

            const labels = data.labels || ['No Data'];
            const counts = data.counts || [0];

            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Admissions',
                        data: counts,
                        borderColor: '#1cc88a',
                        backgroundColor: 'rgba(28, 200, 138, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 10
                                },
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                },
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading monthly admissions data:', error);
            // Show error state chart
            const ctx = document.getElementById('monthlyAdmissionsChart').getContext('2d');
            if (monthlyChart) {
                monthlyChart.destroy();
            }
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Error Loading Data'],
                    datasets: [{
                        label: 'Error',
                        data: [0],
                        borderColor: '#e74a3b',
                        backgroundColor: 'rgba(231, 74, 59, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        });
}
</script>
{% endblock %}