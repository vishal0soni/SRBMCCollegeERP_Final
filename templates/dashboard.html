{% extends "base.html" %} {% block title %}Dashboard - SRBMC ERP{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <!-- <i class="fas fa-tachometer-alt"></i>
            Dashboard-->
            <small class="text-muted"
                >Welcome, {{ current_user.first_name }}!</small
            >
        </h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div
                            class="text-xs font-weight-bold text-primary text-uppercase mb-1"
                        >
                            Total Students
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.total_students }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i
                            class="fas fa-graduation-cap fa-2x text-gray-300"
                        ></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div
                            class="text-xs font-weight-bold text-success text-uppercase mb-1"
                        >
                            Active Students
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.active_students }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-check fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div
                            class="text-xs font-weight-bold text-info text-uppercase mb-1"
                        >
                            Total Collected Fees
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            ₹{{ "%.2f"|format(stats.total_collected_fees) }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-coins fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div
                            class="text-xs font-weight-bold text-warning text-uppercase mb-1"
                        >
                            Pending Fees
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            ₹{{ "%.2f"|format(stats.pending_fees) }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-rupee-sign fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Global Filter Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    Dashboard Filters
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="courseFilter" class="form-label"
                            >Filter by Course:</label
                        >
                        <select
                            id="courseFilter"
                            class="form-select"
                            onchange="applyGlobalFilter()"
                        >
                            <option value="">All Courses</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label"
                            >Filter by Status:</label
                        >
                        <select
                            id="statusFilter"
                            class="form-select"
                            onchange="applyGlobalFilter()"
                        >
                            <option value="">All Status</option>
                            <option value="Active">Active</option>
                            <option value="Dropout">Dropout</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="genderFilter" class="form-label"
                            >Filter by Gender:</label
                        >
                        <select
                            id="genderFilter"
                            class="form-select"
                            onchange="applyGlobalFilter()"
                        >
                            <option value="">All Genders</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="mt-4">
                            <button
                                class="btn btn-secondary"
                                onclick="resetFilters()"
                            >
                                Reset Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row - Both charts in balanced layout -->
<div class="row mb-4">
    <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div
                class="card-header py-3 d-flex justify-content-between align-items-center"
            >
                <h6 class="m-0 font-weight-bold text-primary">
                    Student Distribution by Course
                </h6>
                <div class="text-muted">
                    <small
                        >Total Students:
                        <span id="totalStudentsCount"
                            >{{ stats.total_students }}</span
                        ></small
                    >
                </div>
            </div>
            <div class="card-body" style="height: 400px">
                <canvas id="courseChart" style="max-height: 350px"></canvas>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    Monthly Fee Collections
                </h6>
            </div>
            <div class="card-body" style="height: 400px">
                <canvas id="feeChart" style="max-height: 350px"></canvas>
            </div>
        </div>
    </div>
</div></div>

<!-- Recent Activities -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    Recent Student Admissions
                </h6>
            </div>
            <div class="card-body">
                {% if recent_students %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Course</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in recent_students %}
                            <tr>
                                <td>{{ student.student_unique_id }}</td>
                                <td>
                                    {{ student.first_name }} {{
                                    student.last_name }}
                                </td>
                                <td>{{ student.current_course or 'N/A' }}</td>
                                <td>
                                    {{ student.created_at.strftime('%d/%m/%Y')
                                    if student.created_at else 'N/A' }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No recent admissions</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    Recent Payments
                </h6>
            </div>
            <div class="card-body">
                {% if recent_payments %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Student</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in recent_payments %}
                            <tr>
                                <td>{{ payment.invoice_number }}</td>
                                <td>
                                    {{ payment.student.first_name }} {{
                                    payment.student.last_name }}
                                </td>
                                <td>
                                    ₹{{ "%.2f"|format(payment.invoice_amount) }}
                                </td>
                                <td>
                                    {{ payment.date_time.strftime('%d/%m/%Y') if
                                    payment.date_time else 'N/A' }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No recent payments</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
    let courseChart;
    let feeChart;
    let globalFilters = {
        course: "",
        status: "",
        gender: "",
    };

    // Load dashboard charts with dynamic data
    document.addEventListener("DOMContentLoaded", function () {
        loadCourseOptions();
        loadStudentDistributionChart();
        loadFeeChart();
    });

    function loadCourseOptions() {
        fetch("/api/course-list")
            .then((response) => response.json())
            .then((data) => {
                const courseFilter = document.getElementById("courseFilter");
                data.courses.forEach((course) => {
                    const option = document.createElement("option");
                    option.value = course;
                    option.textContent = course;
                    courseFilter.appendChild(option);
                });
            })
            .catch((error) => console.error("Error loading courses:", error));
    }

    function applyGlobalFilter() {
        globalFilters.course = document.getElementById("courseFilter").value;
        globalFilters.status = document.getElementById("statusFilter").value;
        globalFilters.gender = document.getElementById("genderFilter").value;

        loadStudentDistributionChart();
    }

    function resetFilters() {
        document.getElementById("courseFilter").value = "";
        document.getElementById("statusFilter").value = "";
        document.getElementById("genderFilter").value = "";
        globalFilters = { course: "", status: "", gender: "" };
        loadStudentDistributionChart();
    }

    function loadStudentDistributionChart() {
        const params = new URLSearchParams(globalFilters);

        fetch(`/api/student-stats?${params}`)
            .then((response) => response.json())
            .then((data) => {
                const ctx = document
                    .getElementById("courseChart")
                    .getContext("2d");

                // Destroy existing chart if it exists
                if (courseChart) {
                    courseChart.destroy();
                }

                // Handle empty data case
                if (!data.courses || data.courses.length === 0) {
                    data.courses = ["No Data Available"];
                    data.counts = [0];
                }

                // Update total students count
                const totalStudents = data.counts.reduce((a, b) => a + b, 0);
                document.getElementById("totalStudentsCount").textContent =
                    totalStudents;

                // Calculate percentages
                        const totalStudents = data.counts.reduce((a, b) => a + b, 0);
                        const percentages = data.counts.map(count => 
                            totalStudents > 0 ? ((count / totalStudents) * 100).toFixed(1) : 0
                        );

                        courseChart = new Chart(ctx, {
                            type: "doughnut",
                            data: {
                                labels: data.courses,
                                datasets: [
                                    {
                                        data: percentages,
                                        backgroundColor: [
                                            "#4e73df",
                                            "#1cc88a",
                                            "#36b9cc",
                                            "#f6c23e",
                                            "#e74a3b",
                                            "#858796",
                                            "#5a5c69",
                                            "#2c5282",
                                            "#1a365d",
                                            "#3182ce",
                                            "#fd7e14",
                                            "#6f42c1",
                                        ],
                                        borderWidth: 2,
                                        borderColor: "#fff",
                                    },
                                ],
                            },
                    plugins: [ChartDataLabels],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: "bottom",
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: {
                                        size: 11,
                                    },
                                    generateLabels: function (chart) {
                                        const original =
                                            Chart.defaults.plugins.legend.labels
                                                .generateLabels;
                                        const labels = original.call(
                                            this,
                                            chart,
                                        );

                                        labels.forEach((label, index) => {
                                            const percentage = chart.data.datasets[0].data[index];
                                            const courseName = chart.data.labels[index];

                                            // Truncate long course names for legend
                                            const displayName =
                                                courseName.length > 20
                                                    ? courseName.substring(0, 17) + "..."
                                                    : courseName;

                                            label.text = `${displayName} (${percentage}%)`;
                                        });

                                        return labels;
                                    },
                                },
                            },
                            tooltip: {
                                callbacks: {
                                    title: function (context) {
                                        return `Course: ${context[0].label}`;
                                    },
                                    label: function (context) {
                                        const courseIndex = context.dataIndex;
                                        const studentCount = data.counts[courseIndex];
                                        const percentage = context.parsed;
                                        return [
                                            `Students: ${studentCount}`,
                                            `Percentage: ${percentage}%`,
                                            `Total Students: ${totalStudents}`,
                                        ];
                                    },
                                    afterLabel: function (context) {
                                        const courseIndex = context.dataIndex;
                                        const studentCount = data.counts[courseIndex];
                                        if (studentCount === 1) {
                                            return "1 student enrolled";
                                        } else if (studentCount === 0) {
                                            return "No students enrolled";
                                        } else {
                                            return `${studentCount} students enrolled`;
                                        }
                                    },
                                },
                                backgroundColor: "rgba(0, 0, 0, 0.8)",
                                titleColor: "#fff",
                                bodyColor: "#fff",
                                borderColor: "#4e73df",
                                borderWidth: 1,
                                cornerRadius: 6,
                                displayColors: true,
                                titleFont: {
                                    size: 14,
                                    weight: "bold",
                                },
                                bodyFont: {
                                    size: 12,
                                },
                            },
                            datalabels: {
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                formatter: function(value, context) {
                                    return value + '%';
                                },
                                display: function(context) {
                                    const value = parseFloat(context.dataset.data[context.dataIndex]);
                                    return value > 5; // Only show percentages for slices larger than 5%
                                }
                            }
                        },
                        cutout: "40%",
                    },
                });
            })
            .catch((error) => {
                console.error("Error loading course distribution data:", error);
                // Show placeholder chart on error
                const ctx = document
                    .getElementById("courseChart")
                    .getContext("2d");
                if (courseChart) {
                    courseChart.destroy();
                }
                courseChart = new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: ["Error Loading Data"],
                        datasets: [
                            {
                                data: [1],
                                backgroundColor: ["#e3e6f0"],
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: "bottom",
                            },
                        },
                    },
                });
            });
    }

    function loadFeeChart() {
        fetch("/api/fee-stats")
            .then((response) => response.json())
            .then((data) => {
                const ctx = document
                    .getElementById("feeChart")
                    .getContext("2d");
                const monthNames = [
                    "Jan",
                    "Feb",
                    "Mar",
                    "Apr",
                    "May",
                    "Jun",
                    "Jul",
                    "Aug",
                    "Sep",
                    "Oct",
                    "Nov",
                    "Dec",
                ];

                if (feeChart) {
                    feeChart.destroy();
                }

                feeChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: monthNames,
                        datasets: [
                            {
                                label: `Fee Collections ${new Date().getFullYear()}`,
                                data: data.amounts,
                                borderColor: "#1cc88a",
                                backgroundColor: "rgba(28, 200, 138, 0.3)",
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: "#1cc88a",
                                pointBorderColor: "#fff",
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 8,
                                pointHoverBorderWidth: 3,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    },
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return `${context[0].label} ${new Date().getFullYear()}`;
                                    },
                                    label: function (context) {
                                        return (
                                            "Collections: ₹" +
                                            context.parsed.y.toLocaleString('en-IN')
                                        );
                                    },
                                },
                                backgroundColor: "rgba(0, 0, 0, 0.8)",
                                titleColor: "#fff",
                                bodyColor: "#fff",
                                cornerRadius: 6,
                                borderColor: "#1cc88a",
                                borderWidth: 1,
                            },
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: "#e3e6f0",
                                    drawBorder: false,
                                },
                                ticks: {
                                    callback: function (value) {
                                        if (value >= 100000) {
                                            return "₹" + (value/100000).toFixed(1) + "L";
                                        } else if (value >= 1000) {
                                            return "₹" + (value/1000).toFixed(0) + "K";
                                        } else {
                                            return "₹" + value;
                                        }
                                    },
                                    color: "#5a5c69",
                                    font: {
                                        size: 11,
                                    },
                                    padding: 10,
                                },
                                border: {
                                    display: false,
                                },
                            },
                            x: {
                                grid: {
                                    color: "#e3e6f0",
                                    drawBorder: false,
                                },
                                ticks: {
                                    color: "#5a5c69",
                                    font: {
                                        size: 11,
                                    },
                                    padding: 10,
                                },
                                border: {
                                    display: false,
                                },
                            },
                        },
                        interaction: {
                            intersect: false,
                            mode: "index",
                        },
                        elements: {
                            line: {
                                borderWidth: 3,
                            },
                        },
                    },
                });
            })
            .catch((error) => {
                console.error("Error loading fee collections data:", error);
                // Show placeholder chart on error
                const ctx = document
                    .getElementById("feeChart")
                    .getContext("2d");
                const monthNames = [
                    "Jan",
                    "Feb",
                    "Mar",
                    "Apr",
                    "May",
                    "Jun",
                    "Jul",
                    "Aug",
                    "Sep",
                    "Oct",
                    "Nov",
                    "Dec",
                ];
                if (feeChart) {
                    feeChart.destroy();
                }
                feeChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: monthNames,
                        datasets: [
                            {
                                label: "No Data Available",
                                data: Array(12).fill(0),
                                borderColor: "#e3e6f0",
                                backgroundColor: "rgba(227, 230, 240, 0.1)",
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                            },
                        },
                    },
                });
            });
    }
</script>
{% endblock %}
