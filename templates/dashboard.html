
<style>
.updated {
    background-color: #d4edda !important;
    border: 1px solid #c3e6cb !important;
    color: #155724 !important;
    border-radius: 4px;
    transition: all 0.5s ease;
}

.card-body .h5.updated {
    padding: 2px 6px;
    margin: -2px -6px;
}

#yearFilter:disabled {
    opacity: 0.6;
    cursor: wait;
}

.loading-indicator {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 8px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

{% extends "base.html" %} {% block title %}Dashboard - SRBMC ERP{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <!-- <i class="fas fa-tachometer-alt"></i>
            Dashboard-->
            <small class="text-muted"
                >Welcome, {{ current_user.first_name }}!</small
            >
        </h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div
                            class="text-xs font-weight-bold text-primary text-uppercase mb-1"
                        >
                            Total Students
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.total_students }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i
                            class="fas fa-graduation-cap fa-2x text-gray-300"
                        ></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div
                            class="text-xs font-weight-bold text-success text-uppercase mb-1"
                        >
                            Active Students
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.active_students }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-check fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div
                            class="text-xs font-weight-bold text-info text-uppercase mb-1"
                        >
                            Total Collected Fees
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            ₹{{ "%.2f"|format(stats.total_collected_fees) }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-coins fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div
                            class="text-xs font-weight-bold text-warning text-uppercase mb-1"
                        >
                            Pending Fees
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            ₹{{ "%.2f"|format(stats.pending_fees) }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-rupee-sign fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Global Year Filter Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calendar-alt"></i> Academic Year Filter
                </h6>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label for="yearFilter" class="form-label">Select Academic Year:</label>
                        <select id="yearFilter" class="form-select" onchange="applyYearFilter()">
                            <!-- Years will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-8">
                        <div class="text-muted">
                            <small>
                                <i class="fas fa-info-circle"></i>
                                All charts and statistics will update automatically when you change the year.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div></div>

<!-- Charts Row - Both charts in balanced layout -->
<div class="row mb-4">
    <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div
                class="card-header py-3 d-flex justify-content-between align-items-center"
            >
                <h6 class="m-0 font-weight-bold text-primary">
                    Student Distribution by Course
                </h6>
                <div class="text-muted">
                    <small
                        >Total Students:
                        <span id="totalStudentsCount"
                            >{{ stats.total_students }}</span
                        ></small
                    >
                </div>
            </div>
            <div class="card-body" style="height: 400px">
                <canvas id="courseChart" style="max-height: 350px"></canvas>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    Monthly Fee Collections
                </h6>
            </div>
            <div class="card-body" style="height: 400px">
                <canvas id="feeChart" style="max-height: 350px"></canvas>
            </div>
        </div>
    </div>
</div></div>

<!-- Recent Activities -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    Recent Student Admissions
                </h6>
            </div>
            <div class="card-body">
                {% if recent_students %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Course</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in recent_students %}
                            <tr>
                                <td>{{ student.student_unique_id }}</td>
                                <td>
                                    {{ student.first_name }} {{
                                    student.last_name }}
                                </td>
                                <td>{{ student.current_course or 'N/A' }}</td>
                                <td>
                                    {{ student.created_at.strftime('%d/%m/%Y')
                                    if student.created_at else 'N/A' }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No recent admissions</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    Recent Payments
                </h6>
            </div>
            <div class="card-body">
                {% if recent_payments %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Student</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in recent_payments %}
                            <tr>
                                <td>{{ payment.invoice_number }}</td>
                                <td>
                                    {{ payment.student.first_name }} {{
                                    payment.student.last_name }}
                                </td>
                                <td>
                                    ₹{{ "%.2f"|format(payment.invoice_amount) }}
                                </td>
                                <td>
                                    {{ payment.date_time.strftime('%d/%m/%Y') if
                                    payment.date_time else 'N/A' }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No recent payments</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
    let courseChart;
    let feeChart;
    let currentYear = new Date().getFullYear();

    // Load dashboard charts with dynamic data
    document.addEventListener("DOMContentLoaded", function () {
        loadYearOptions();
        loadDashboardStats();
        loadStudentDistributionChart();
        loadFeeChart();
    });

    function loadYearOptions() {
        const yearFilter = document.getElementById("yearFilter");
        const startYear = 2020; // Earliest year to show
        const endYear = new Date().getFullYear() + 1; // Current year + 1

        for (let year = endYear; year >= startYear; year--) {
            const option = document.createElement("option");
            option.value = year;
            option.textContent = `${year}-${(year + 1).toString().slice(-2)}`;
            
            // Set current year as default
            if (year === currentYear) {
                option.selected = true;
            }
            
            yearFilter.appendChild(option);
        }
    }

    function applyYearFilter() {
        const selectedYear = parseInt(document.getElementById("yearFilter").value);
        currentYear = selectedYear;
        
        console.log('Year filter changed to:', currentYear);
        
        // Show loading indicator
        const yearFilter = document.getElementById("yearFilter");
        yearFilter.disabled = true;
        
        // Add loading text
        const loadingText = document.createElement('span');
        loadingText.innerHTML = ' <i class="fas fa-spinner fa-spin"></i> Loading...';
        loadingText.id = 'loading-indicator';
        yearFilter.parentNode.appendChild(loadingText);
        
        // Update all dashboard components
        Promise.all([
            loadDashboardStats(),
            loadStudentDistributionChart(),
            loadFeeChart()
        ]).then(() => {
            yearFilter.disabled = false;
            const loader = document.getElementById('loading-indicator');
            if (loader) loader.remove();
            console.log('Dashboard updated for year:', currentYear);
        }).catch((error) => {
            console.error('Error updating dashboard:', error);
            yearFilter.disabled = false;
            const loader = document.getElementById('loading-indicator');
            if (loader) loader.remove();
            alert('Error updating dashboard data. Please try again.');
        });
    }

    function loadDashboardStats() {
        return fetch(`/api/dashboard-stats?year=${currentYear}`)
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    console.log('Dashboard stats loaded:', data.stats);
                    
                    // Update dashboard statistics cards
                    const totalStudentsElement = document.querySelector('.border-left-primary .h5');
                    const activeStudentsElement = document.querySelector('.border-left-success .h5');
                    const totalFeesElement = document.querySelector('.border-left-info .h5');
                    const pendingFeesElement = document.querySelector('.border-left-warning .h5');
                    
                    if (totalStudentsElement) {
                        totalStudentsElement.textContent = data.stats.total_students;
                        totalStudentsElement.classList.add('updated');
                        setTimeout(() => totalStudentsElement.classList.remove('updated'), 1000);
                    }
                    if (activeStudentsElement) {
                        activeStudentsElement.textContent = data.stats.active_students;
                        activeStudentsElement.classList.add('updated');
                        setTimeout(() => activeStudentsElement.classList.remove('updated'), 1000);
                    }
                    if (totalFeesElement) {
                        totalFeesElement.textContent = `₹${parseFloat(data.stats.total_collected_fees).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
                        totalFeesElement.classList.add('updated');
                        setTimeout(() => totalFeesElement.classList.remove('updated'), 1000);
                    }
                    if (pendingFeesElement) {
                        pendingFeesElement.textContent = `₹${parseFloat(data.stats.pending_fees).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
                        pendingFeesElement.classList.add('updated');
                        setTimeout(() => pendingFeesElement.classList.remove('updated'), 1000);
                    }
                } else {
                    console.error('Dashboard stats API returned error:', data.error);
                }
            })
            .catch((error) => {
                console.error("Error loading dashboard stats:", error);
                throw error;
            });
    }

    function loadStudentDistributionChart() {
        return fetch(`/api/student-stats?year=${currentYear}`)
            .then((response) => response.json())
            .then((data) => {
                console.log('Student distribution data loaded:', data);
                
                const ctx = document
                    .getElementById("courseChart")
                    .getContext("2d");

                // Destroy existing chart if it exists
                if (courseChart) {
                    courseChart.destroy();
                }

                // Handle empty data case
                if (!data.courses || data.courses.length === 0 || data.counts.every(count => count === 0)) {
                    data.courses = [`No Students for ${currentYear}`];
                    data.counts = [1];
                }

                // Update total students count
                const totalStudents = data.counts.reduce((a, b) => a + b, 0);
                const totalStudentsCountElement = document.getElementById("totalStudentsCount");
                if (totalStudentsCountElement) {
                    totalStudentsCountElement.textContent = totalStudents;
                    totalStudentsCountElement.classList.add('updated');
                    setTimeout(() => totalStudentsCountElement.classList.remove('updated'), 1000);
                }

                // Calculate percentages
                const percentages = data.counts.map(count => 
                    totalStudents > 0 ? ((count / totalStudents) * 100).toFixed(1) : 0
                );

                courseChart = new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: data.courses,
                        datasets: [
                            {
                                data: data.counts, // Use actual counts for chart display
                                backgroundColor: [
                                    "#4e73df",
                                    "#1cc88a",
                                    "#36b9cc",
                                    "#f6c23e",
                                    "#e74a3b",
                                    "#858796",
                                    "#5a5c69",
                                    "#2c5282",
                                    "#1a365d",
                                    "#3182ce",
                                    "#fd7e14",
                                    "#6f42c1",
                                    "#ff6384",
                                    "#ffcd56",
                                    "#ff9f40",
                                    "#4bc0c0",
                                    "#9966ff",
                                    "#c9cbcf",
                                    "#ff6b9d",
                                    "#c449c2"
                                ],
                                borderWidth: 2,
                                borderColor: "#fff",
                            },
                        ],
                    },
                    plugins: [ChartDataLabels],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: "bottom",
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: {
                                        size: 11,
                                    },
                                    generateLabels: function (chart) {
                                        const original =
                                            Chart.defaults.plugins.legend.labels
                                                .generateLabels;
                                        const labels = original.call(
                                            this,
                                            chart,
                                        );

                                        labels.forEach((label, index) => {
                                            const studentCount = data.counts[index];
                                            const percentage = percentages[index];
                                            const courseName = chart.data.labels[index];

                                            // Truncate long course names for legend
                                            const displayName =
                                                courseName.length > 25
                                                    ? courseName.substring(0, 22) + "..."
                                                    : courseName;

                                            label.text = `${displayName} (${studentCount} - ${percentage}%)`;
                                        });

                                        return labels;
                                    },
                                },
                            },
                            tooltip: {
                                callbacks: {
                                    title: function (context) {
                                        return `${context[0].label}`;
                                    },
                                    label: function (context) {
                                        const courseIndex = context.dataIndex;
                                        const studentCount = data.counts[courseIndex];
                                        const percentage = percentages[courseIndex];
                                        const courseName = context.label;
                                        
                                        return [
                                            `Course: ${courseName}`,
                                            `Total Students: ${studentCount}`,
                                            `Percentage: ${percentage}%`,
                                            `Academic Year: ${currentYear}-${(currentYear + 1).toString().slice(-2)}`
                                        ];
                                    },
                                    footer: function (context) {
                                        const courseIndex = context[0].dataIndex;
                                        const studentCount = data.counts[courseIndex];
                                        if (studentCount === 1) {
                                            return "1 student enrolled in this course";
                                        } else if (studentCount === 0) {
                                            return "No students enrolled";
                                        } else {
                                            return `${studentCount} students enrolled in this course`;
                                        }
                                    },
                                },
                                backgroundColor: "rgba(0, 0, 0, 0.9)",
                                titleColor: "#fff",
                                bodyColor: "#fff",
                                footerColor: "#ccc",
                                borderColor: "#4e73df",
                                borderWidth: 2,
                                cornerRadius: 8,
                                displayColors: true,
                                titleFont: {
                                    size: 14,
                                    weight: "bold",
                                },
                                bodyFont: {
                                    size: 13,
                                },
                                footerFont: {
                                    size: 11,
                                    style: 'italic'
                                },
                                padding: 12,
                                caretPadding: 8,
                            },
                            datalabels: {
                                color: function(context) {
                                    // Use white for dark backgrounds, dark for light backgrounds
                                    const bgColor = context.dataset.backgroundColor[context.dataIndex];
                                    return '#fff';
                                },
                                font: {
                                    weight: 'bold',
                                    size: 12
                                },
                                formatter: function(value, context) {
                                    const percentage = percentages[context.dataIndex];
                                    return `${percentage}%`;
                                },
                                display: function(context) {
                                    const percentage = parseFloat(percentages[context.dataIndex]);
                                    return percentage > 3; // Only show percentages for slices larger than 3%
                                },
                                textStrokeColor: '#000',
                                textStrokeWidth: 1,
                            }
                        },
                        cutout: "45%",
                        onHover: function(event, activeElements) {
                            // Change cursor to pointer when hovering over chart segments
                            event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                        },
                    },
                });
            })
            .catch((error) => {
                console.error("Error loading course distribution data:", error);
                // Show placeholder chart on error
                const ctx = document
                    .getElementById("courseChart")
                    .getContext("2d");
                if (courseChart) {
                    courseChart.destroy();
                }
                courseChart = new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: ["Error Loading Data"],
                        datasets: [
                            {
                                data: [1],
                                backgroundColor: ["#e3e6f0"],
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: "bottom",
                            },
                            tooltip: {
                                callbacks: {
                                    label: function() {
                                        return "Failed to load course data";
                                    }
                                }
                            }
                        },
                    },
                });
                throw error;
            });
    }

    function loadFeeChart() {
        return fetch(`/api/fee-stats?year=${currentYear}`)
            .then((response) => response.json())
            .then((data) => {
                console.log('Fee chart data loaded:', data);
                const ctx = document
                    .getElementById("feeChart")
                    .getContext("2d");
                const monthNames = [
                    "Jan",
                    "Feb",
                    "Mar",
                    "Apr",
                    "May",
                    "Jun",
                    "Jul",
                    "Aug",
                    "Sep",
                    "Oct",
                    "Nov",
                    "Dec",
                ];

                if (feeChart) {
                    feeChart.destroy();
                }

                feeChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: monthNames,
                        datasets: [
                            {
                                label: `Fee Collections ${currentYear}-${(currentYear + 1).toString().slice(-2)}`,
                                data: data.amounts,
                                borderColor: "#1cc88a",
                                backgroundColor: "rgba(28, 200, 138, 0.3)",
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: "#1cc88a",
                                pointBorderColor: "#fff",
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 8,
                                pointHoverBorderWidth: 3,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    },
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return `${context[0].label} ${new Date().getFullYear()}`;
                                    },
                                    label: function (context) {
                                        return (
                                            "Collections: ₹" +
                                            context.parsed.y.toLocaleString('en-IN')
                                        );
                                    },
                                },
                                backgroundColor: "rgba(0, 0, 0, 0.8)",
                                titleColor: "#fff",
                                bodyColor: "#fff",
                                cornerRadius: 6,
                                borderColor: "#1cc88a",
                                borderWidth: 1,
                            },
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: "#e3e6f0",
                                    drawBorder: false,
                                },
                                ticks: {
                                    callback: function (value) {
                                        if (value >= 100000) {
                                            return "₹" + (value/100000).toFixed(1) + "L";
                                        } else if (value >= 1000) {
                                            return "₹" + (value/1000).toFixed(0) + "K";
                                        } else {
                                            return "₹" + value;
                                        }
                                    },
                                    color: "#5a5c69",
                                    font: {
                                        size: 11,
                                    },
                                    padding: 10,
                                },
                                border: {
                                    display: false,
                                },
                            },
                            x: {
                                grid: {
                                    color: "#e3e6f0",
                                    drawBorder: false,
                                },
                                ticks: {
                                    color: "#5a5c69",
                                    font: {
                                        size: 11,
                                    },
                                    padding: 10,
                                },
                                border: {
                                    display: false,
                                },
                            },
                        },
                        interaction: {
                            intersect: false,
                            mode: "index",
                        },
                        elements: {
                            line: {
                                borderWidth: 3,
                            },
                        },
                    },
                });
            })
            .catch((error) => {
                console.error("Error loading fee collections data:", error);
                // Show placeholder chart on error
                const ctx = document
                    .getElementById("feeChart")
                    .getContext("2d");
                const monthNames = [
                    "Jan",
                    "Feb",
                    "Mar",
                    "Apr",
                    "May",
                    "Jun",
                    "Jul",
                    "Aug",
                    "Sep",
                    "Oct",
                    "Nov",
                    "Dec",
                ];
                if (feeChart) {
                    feeChart.destroy();
                }
                feeChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: monthNames,
                        datasets: [
                            {
                                label: "No Data Available",
                                data: Array(12).fill(0),
                                borderColor: "#e3e6f0",
                                backgroundColor: "rgba(227, 230, 240, 0.1)",
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                            },
                        },
                    },
                });
                throw error;
            });
    }
</script>
{% endblock %}
