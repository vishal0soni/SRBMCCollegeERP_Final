
<style>
.updated {
    background-color: #d4edda !important;
    border: 1px solid #c3e6cb !important;
    color: #155724 !important;
    border-radius: 4px;
    transition: all 0.5s ease;
}

.card-body .h5.updated {
    padding: 2px 6px;
    margin: -2px -6px;
}

#yearFilter:disabled {
    opacity: 0.6;
    cursor: wait;
}

.loading-indicator {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 8px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

{% extends "base.html" %} {% block title %}Dashboard - SRBMC ERP{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <!-- <i class="fas fa-tachometer-alt"></i>
            Dashboard-->
            <small class="text-muted"
                >Welcome, {{ current_user.first_name }}!</small
            >
        </h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div
                            class="text-xs font-weight-bold text-primary text-uppercase mb-1"
                        >
                            Total Students
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.total_students }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i
                            class="fas fa-graduation-cap fa-2x text-gray-300"
                        ></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div
                            class="text-xs font-weight-bold text-success text-uppercase mb-1"
                        >
                            Active Students
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.active_students }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-check fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div
                            class="text-xs font-weight-bold text-info text-uppercase mb-1"
                        >
                            Total Collected Fees
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            ₹{{ "%.2f"|format(stats.total_collected_fees) }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-coins fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div
                            class="text-xs font-weight-bold text-warning text-uppercase mb-1"
                        >
                            Pending Fees
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            ₹{{ "%.2f"|format(stats.pending_fees) }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-rupee-sign fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Global Year Filter Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calendar-alt"></i> Academic Year Filter
                </h6>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label for="yearFilter" class="form-label">Select Academic Year:</label>
                        <select id="yearFilter" class="form-select" onchange="applyYearFilter()">
                            <!-- Years will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-8">
                        <div class="text-muted">
                            <small>
                                <i class="fas fa-info-circle"></i>
                                All charts and statistics will update automatically when you change the year.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div></div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Course Distribution Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-pie"></i> Student Distribution by Course
                </h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="courseDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Monthly Fee Collection Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-line"></i> Monthly Fee Collections
                </h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="monthlyFeeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activities -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    Recent Student Admissions
                </h6>
            </div>
            <div class="card-body">
                {% if recent_students %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Course</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in recent_students %}
                            <tr>
                                <td>{{ student.student_unique_id }}</td>
                                <td>
                                    {{ student.first_name }} {{
                                    student.last_name }}
                                </td>
                                <td>{{ student.current_course or 'N/A' }}</td>
                                <td>
                                    {{ student.created_at.strftime('%d/%m/%Y')
                                    if student.created_at else 'N/A' }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No recent admissions</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    Recent Payments
                </h6>
            </div>
            <div class="card-body">
                {% if recent_payments %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Student</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in recent_payments %}
                            <tr>
                                <td>{{ payment.invoice_number }}</td>
                                <td>
                                    {{ payment.student.first_name }} {{
                                    payment.student.last_name }}
                                </td>
                                <td>
                                    ₹{{ "%.2f"|format(payment.invoice_amount) }}
                                </td>
                                <td>
                                    {{ payment.date_time.strftime('%d/%m/%Y') if
                                    payment.date_time else 'N/A' }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No recent payments</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
    let courseDistributionChart;
    let currentYear = new Date().getFullYear();

    // Load dashboard charts with dynamic data
    document.addEventListener("DOMContentLoaded", function () {
        loadYearOptions();
        loadDashboardStats();
        loadCourseDistributionChart();
        loadMonthlyFeeChart();
    });

    function loadYearOptions() {
        const yearFilter = document.getElementById("yearFilter");
        const startYear = 2020; // Earliest year to show
        const endYear = new Date().getFullYear() + 1; // Current year + 1

        for (let year = endYear; year >= startYear; year--) {
            const option = document.createElement("option");
            option.value = year;
            option.textContent = `${year}-${(year + 1).toString().slice(-2)}`;
            
            // Set current year as default
            if (year === currentYear) {
                option.selected = true;
            }
            
            yearFilter.appendChild(option);
        }
    }

    function applyYearFilter() {
        const selectedYear = parseInt(document.getElementById("yearFilter").value);
        currentYear = selectedYear;
        
        console.log('Year filter changed to:', currentYear);
        
        // Show loading indicator
        const yearFilter = document.getElementById("yearFilter");
        yearFilter.disabled = true;
        
        // Update all dashboard components
        Promise.all([
            loadDashboardStats(),
            loadCourseDistributionChart(),
            loadMonthlyFeeChart()
        ]).then(() => {
            yearFilter.disabled = false;
            console.log('Dashboard updated for year:', currentYear);
        }).catch((error) => {
            console.error('Error updating dashboard:', error);
            yearFilter.disabled = false;
        });
    }

    function loadDashboardStats() {
        return fetch(`/api/dashboard-stats?year=${currentYear}`)
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    console.log('Dashboard stats loaded:', data.stats);
                    
                    // Update dashboard statistics cards
                    const totalStudentsElement = document.querySelector('.border-left-primary .h5');
                    const activeStudentsElement = document.querySelector('.border-left-success .h5');
                    const totalFeesElement = document.querySelector('.border-left-info .h5');
                    const pendingFeesElement = document.querySelector('.border-left-warning .h5');
                    
                    if (totalStudentsElement) {
                        totalStudentsElement.textContent = data.stats.total_students;
                        totalStudentsElement.classList.add('updated');
                        setTimeout(() => totalStudentsElement.classList.remove('updated'), 1000);
                    }
                    if (activeStudentsElement) {
                        activeStudentsElement.textContent = data.stats.active_students;
                        activeStudentsElement.classList.add('updated');
                        setTimeout(() => activeStudentsElement.classList.remove('updated'), 1000);
                    }
                    if (totalFeesElement) {
                        totalFeesElement.textContent = `₹${parseFloat(data.stats.total_collected_fees).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
                        totalFeesElement.classList.add('updated');
                        setTimeout(() => totalFeesElement.classList.remove('updated'), 1000);
                    }
                    if (pendingFeesElement) {
                        pendingFeesElement.textContent = `₹${parseFloat(data.stats.pending_fees).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
                        pendingFeesElement.classList.add('updated');
                        setTimeout(() => pendingFeesElement.classList.remove('updated'), 1000);
                    }
                } else {
                    console.error('Dashboard stats API returned error:', data.error);
                }
            })
            .catch((error) => {
                console.error("Error loading dashboard stats:", error);
                throw error;
            });
    }

    function loadCourseDistributionChart() {
        return fetch(`/api/student-stats?year=${currentYear}`)
            .then((response) => response.json())
            .then((data) => {
                console.log('Course distribution data loaded:', data);
                
                const ctx = document.getElementById("courseDistributionChart").getContext("2d");

                // Destroy existing chart if it exists
                if (courseDistributionChart) {
                    courseDistributionChart.destroy();
                }

                // Handle empty data case
                if (!data.courses || data.courses.length === 0) {
                    data.courses = ["No Students Enrolled"];
                    data.counts = [1];
                }

                // Create doughnut chart
                courseDistributionChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.courses,
                        datasets: [{
                            data: data.counts,
                            backgroundColor: [
                                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796',
                                '#5a5c69', '#2c5282', '#1a365d', '#3182ce', '#fd7e14', '#6f42c1'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        const courseIndex = context.dataIndex;
                                        const studentCount = data.counts[courseIndex];
                                        const totalStudents = data.counts.reduce((a, b) => a + b, 0);
                                        const percentage = totalStudents > 0 ? ((studentCount / totalStudents) * 100).toFixed(1) : 0;
                                        const courseName = context.label;
                                        
                                        return [
                                            `Course: ${courseName}`,
                                            `Total Students: ${studentCount}`,
                                            `Percentage: ${percentage}%`
                                        ];
                                    }
                                },
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#4e73df',
                                borderWidth: 1,
                                cornerRadius: 6
                            }
                        },
                        cutout: '60%'
                    }
                });
            })
            .catch((error) => {
                console.error("Error loading course distribution data:", error);
                // Show placeholder on error
                const ctx = document.getElementById("courseDistributionChart").getContext("2d");
                if (courseDistributionChart) {
                    courseDistributionChart.destroy();
                }
                
                courseDistributionChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Error Loading Data'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#e3e6f0']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                throw error;
            });
    }

    let monthlyFeeChart;

    function loadMonthlyFeeChart() {
        return fetch(`/api/fee-stats?year=${currentYear}`)
            .then((response) => response.json())
            .then((data) => {
                console.log('Monthly fee data loaded:', data);
                
                const ctx = document.getElementById("monthlyFeeChart").getContext("2d");

                // Destroy existing chart if it exists
                if (monthlyFeeChart) {
                    monthlyFeeChart.destroy();
                }

                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                // Create line chart
                monthlyFeeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: monthNames,
                        datasets: [{
                            label: 'Fee Collections (₹)',
                            data: data.amounts || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#1cc88a',
                            backgroundColor: 'rgba(28, 200, 138, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#1cc88a',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Collection: ₹' + context.parsed.y.toLocaleString('en-IN', {minimumFractionDigits: 2});
                                    }
                                },
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#1cc88a',
                                borderWidth: 1,
                                cornerRadius: 6
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '₹' + value.toLocaleString('en-IN');
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch((error) => {
                console.error("Error loading monthly fee data:", error);
                // Show placeholder on error
                const ctx = document.getElementById("monthlyFeeChart").getContext("2d");
                if (monthlyFeeChart) {
                    monthlyFeeChart.destroy();
                }
                
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                monthlyFeeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: monthNames,
                        datasets: [{
                            label: 'Error Loading Data',
                            data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#e3e6f0',
                            backgroundColor: 'rgba(227, 230, 240, 0.1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                throw error;
            });
    }
</script>
{% endblock %}
